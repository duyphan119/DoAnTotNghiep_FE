import { Button, Grid, Paper } from "@mui/material";
import Head from "next/head";
import { useRouter } from "next/router";
import { ChangeEvent, useEffect, useState } from "react";
import { SubmitHandler, useForm } from "react-hook-form";
import "react-quill/dist/quill.snow.css";
import {
  createGroupProduct,
  CreateGroupProductDTO,
  getAllGroupProducts,
} from "../../../apis/groupProduct";
import { uploadSingle } from "../../../apis/upload";
import { FooterForm, InputControl, SelectControl } from "../../../components";
import { AdminLayout } from "../../../layouts";
import { MSG_SUCCESS } from "../../../utils/constants";

type Props = {};

const AddGRoupProduct = (props: Props) => {
  const router = useRouter();
  const [files, setFiles] = useState<FileList | null>(null);
  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<CreateGroupProductDTO>();
  const onSubmit: SubmitHandler<CreateGroupProductDTO> = async (data) => {
    try {
      console.log("CREATE DATA::::", {
        ...data,
        isAdult: "" + data.isAdult === "true" ? true : false,
      });
      let url = "";
      if (files) {
        const formData = new FormData();
        formData.append("image", files[0]);
        const { message, data: dataImage } = await uploadSingle(formData);
        if (message === MSG_SUCCESS) {
          console.log("Uploaded file: ", dataImage);
          url = dataImage.secure_url;
        }
      }
      const { message: msg } = await createGroupProduct({
        ...data,
        isAdult: "" + data.isAdult === "true" ? true : false,
        ...(url !== "" ? { thumbnail: url } : {}),
      });
      if (msg === MSG_SUCCESS) {
        router.push("/admin/group-product");
      }
    } catch (error) {
      console.log(error);
    }
  };

  return (
    <AdminLayout pageTitle="Nhóm sản phẩm">
      <>
        <Head>
          <title>Thêm mới nhóm sản phẩm</title>
          <meta name="description" content="Generated by create next app" />
          <link rel="icon" href="/favicon.ico" />
        </Head>
        <Paper sx={{ padding: "16px" }}>
          <div
            style={{ fontSize: "2rem", fontWeight: "600", marginBottom: 16 }}
          >
            Thông tin thêm nhóm mới sản phẩm
          </div>
          <form onSubmit={handleSubmit(onSubmit)}>
            <Grid container rowSpacing={3} columnSpacing={3}>
              <Grid item xs={12}>
                <InputControl
                  label="Tên nhóm sản phẩm"
                  error={errors.name}
                  register={register("name", {
                    required: {
                      value: true,
                      message: "Tên không được để trống",
                    },
                  })}
                  required={true}
                />
              </Grid>
              <Grid item xs={12}>
                <InputControl
                  label="Mô tả"
                  error={errors.description}
                  register={register("description")}
                />
              </Grid>
              <Grid item xs={12}>
                <SelectControl
                  label="Giới tính"
                  register={register("sex")}
                  options={[
                    { value: "Nam" },
                    { value: "Nữ" },
                    { value: "Unisex" },
                  ]}
                />
              </Grid>
              <Grid item xs={12}>
                <SelectControl
                  label="Đối tượng"
                  register={register("isAdult")}
                  options={[
                    { value: true, display: "Người lớn" },
                    { value: false, display: "Trẻ em" },
                  ]}
                />
              </Grid>
              <Grid item xs={12}>
                <InputControl
                  label="Ảnh đại diện"
                  error={errors.description}
                  onChange={(e: ChangeEvent<HTMLInputElement>) =>
                    setFiles(e.target.files)
                  }
                  type="file"
                />
              </Grid>
              <Grid item xs={12}>
                <FooterForm onBack={() => router.back()} />
              </Grid>
            </Grid>
          </form>
        </Paper>
      </>
    </AdminLayout>
  );
};

export default AddGRoupProduct;
